name: Deploy DNS

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
      MANAGED_TAG: "managed-by=2929-domains"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate build.json exists
        run: |
          if [ ! -f master/build.json ]; then
            echo "âŒ master/build.json not found. Run build workflow first."
            exit 1
          fi

      - name: Backup current build
        run: |
          mkdir -p master
          if [ -f master/build.json ]; then
            cp master/build.json master/backup.json
            echo "ðŸ“¦ Backup saved to master/backup.json"
          fi

      - name: Fetch Cloudflare DNS records
        run: |
          echo "ðŸŒ Fetching Cloudflare DNS records"

          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?per_page=5000" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
          | jq -e '.success == true' > /tmp/cf_raw.json

          jq '.result' /tmp/cf_raw.json > /tmp/cf_all.json

          # Only records managed by this system
          jq --arg tag "$MANAGED_TAG" '
            map(select(.comment != null and (.comment | contains($tag))))
          ' /tmp/cf_all.json > /tmp/cf_managed.json

      - name: Apply DNS changes
        run: |
          set -e

          echo "ðŸ” Syncing DNS records"

          # Build desired state list
          jq -c '.domains[]' master/build.json | while read domain; do
            FQDN=$(echo "$domain" | jq -r '.fqdn')
            OWNER=$(echo "$domain" | jq -r '.owner')

            echo "$domain" | jq -c '.records[]' | while read record; do
              NAME=$(echo "$record" | jq -r '.name')
              TYPE=$(echo "$record" | jq -r '.type')
              VALUE=$(echo "$record" | jq -r '.value')
              PROXIED=$(echo "$record" | jq -r '.proxied // "false"')

              if [[ "$NAME" == "@" ]]; then
                DNS_NAME="$FQDN"
              else
                DNS_NAME="$NAME.$FQDN"
              fi

              EXISTING_ID=$(jq -r \
                --arg name "$DNS_NAME" \
                --arg type "$TYPE" \
                '
                .[] | select(.name == $name and .type == $type) | .id
                ' /tmp/cf_managed.json | head -n1)

              if [[ -z "$EXISTING_ID" ]]; then
                echo "âž• Creating $TYPE $DNS_NAME"

                curl -s -X POST \
                  "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records" \
                  -H "Authorization: Bearer $CF_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  --data "{
                    \"type\": \"$TYPE\",
                    \"name\": \"$DNS_NAME\",
                    \"content\": \"$VALUE\",
                    \"proxied\": $PROXIED,
                    \"comment\": \"$MANAGED_TAG owner=$OWNER\"
                  }" \
                | jq -e '.success == true' > /dev/null

              else
                echo "ðŸ”„ Updating $TYPE $DNS_NAME"

                curl -s -X PUT \
                  "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$EXISTING_ID" \
                  -H "Authorization: Bearer $CF_API_TOKEN" \
                  -H "Content-Type: application/json" \
                  --data "{
                    \"type\": \"$TYPE\",
                    \"name\": \"$DNS_NAME\",
                    \"content\": \"$VALUE\",
                    \"proxied\": $PROXIED,
                    \"comment\": \"$MANAGED_TAG owner=$OWNER\"
                  }" \
                | jq -e '.success == true' > /dev/null
              fi
            done
          done

      - name: Remove stale Cloudflare records
        run: |
          echo "ðŸ§¹ Removing stale records"

          jq -c '.[]' /tmp/cf_managed.json | while read cf; do
            CF_ID=$(echo "$cf" | jq -r '.id')
            CF_NAME=$(echo "$cf" | jq -r '.name')
            CF_TYPE=$(echo "$cf" | jq -r '.type')

            FOUND=$(jq -r \
              --arg name "$CF_NAME" \
              --arg type "$CF_TYPE" \
              '
              .domains[].records[]
              | select(.type == $type)
              | .name
              ' master/build.json | grep -F "$CF_NAME" || true)

            if [[ -z "$FOUND" ]]; then
              echo "âŒ Deleting $CF_TYPE $CF_NAME"

              curl -s -X DELETE \
                "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$CF_ID" \
                -H "Authorization: Bearer $CF_API_TOKEN" \
              | jq -e '.success == true' > /dev/null
            fi
          done

      - name: Deployment complete
        run: |
          echo "âœ… Cloudflare DNS fully synced with build.json"
